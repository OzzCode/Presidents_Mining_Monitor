{% extends "base.html" %}

{% block title %}Profitability - Mining Monitor{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .profitability-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 0 1.5rem 0;
            color: var(--text);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.75rem;
        }

        .btc-price-banner {
            background: linear-gradient(135deg, #f7931a 0%, #ff8c00 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btc-price-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        .btc-price-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .btc-price-main {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1.2;
            margin: 0.25rem 0;
        }

        .btc-price-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .network-diff {
            text-align: right;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .metric-card.profit {
            border-left: 4px solid #28a745;
        }

        .metric-card.revenue {
            border-left: 4px solid #007bff;
        }

        .metric-card.cost {
            border-left: 4px solid #dc3545;
        }

        .metric-card.hashrate {
            border-left: 4px solid #6f42c1;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin: 0.5rem 0;
            line-height: 1.2;
        }

        .metric-sub {
            font-size: 14px;
            color: var(--muted);
        }

        .metric-positive {
            color: #28a745;
        }

        .metric-negative {
            color: #dc3545;
        }

        .chart-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            margin: 2rem 0;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .chart-container:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin: 0 0 1.5rem 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            border-radius: 0.25rem 0.25rem 0 0;
            margin-bottom: -2px;
        }

        .tab:focus {
            outline: 2px solid var(--ring);
            outline-offset: 2px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: var(--surface-2);
        }

        .tab:hover {
            color: var(--primary);
        }

        .breakdown-table {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 12px;
            background: var(--surface-2);
            font-size: 13px;
            font-weight: 600;
            color: var(--muted-2);
            border-bottom: 2px solid var(--border);
        }

        tbody td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--text);
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: var(--surface-2);
        }

        .loading {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--muted);
            background: var(--surface);
            border-radius: 12px;
            border: 1px dashed var(--border);
            margin: 1.5rem 0;
        }

        .loading-spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .period-selector {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .period-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-btn:hover {
            background-color: var(--surface-2);
            border-color: var(--primary);
            color: var(--primary);
        }

        .period-btn.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .period-btn:focus {
            outline: 2px solid var(--ring);
            outline-offset: 2px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--surface);
            border-radius: 12px;
            flex-wrap: wrap;
            border: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted-2);
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            min-width: 150px;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: 2px solid var(--ring);
            outline-offset: 2px;
            border-color: var(--primary);
        }

        .filter-indicator {
            font-size: 12px;
            color: var(--primary);
            font-weight: 500;
        }

        /* Navigation hover effects */
        nav a:hover {
            background-color: var(--surface-2) !important;
            color: var(--primary) !important;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .profitability-container {
                padding: 1rem;
            }

            .btc-price-banner {
                padding: 1.5rem;
            }

            .btc-price-content {
                flex-direction: column;
                text-align: center;
            }

            .network-diff {
                text-align: center;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }

            .filter-select {
                width: 100%;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="profitability-container">
        <h1>Profitability Dashboard</h1>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-group">
                <div class="filter-label">Miner Filter</div>
                <select class="filter-select" id="minerFilter">
                    <option value="all">All Miners</option>
                    <option value="active">Active Miners Only</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Time Period</div>
                <select class="filter-select" id="timeFilter">
                    <option value="24h">Past 24 Hours</option>
                    <option value="7d" selected>Past 7 Days</option>
                    <option value="30d">Past 30 Days</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Electricity Rate ($/kWh)</div>
                <input type="number" id="powerRate" class="filter-select" style="min-width: 120px;"
                       step="0.001" min="0" placeholder="0.10">
            </div>
            <div class="filter-indicator" id="filterIndicator">
                Showing: All Miners • Past 7 Days
            </div>
        </div>

        <!-- BTC Price Banner -->
        <div class="btc-price-banner">
            <div class="btc-price-content">
                <div>
                    <div class="btc-price-label">Bitcoin Price (USD)</div>
                    <div class="btc-price-main" id="btc-price">Loading...</div>
                </div>
                <div class="network-diff">
                    <div class="btc-price-label">Network Difficulty</div>
                    <div style="font-size: 24px; font-weight: 600;" id="network-diff">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid" id="metrics-grid">
            <div class="metric-card profit">
                <div class="metric-label">Daily Profit</div>
                <div class="metric-value" id="daily-profit">-</div>
                <div class="metric-sub">
                    <span id="monthly-profit">-</span> / month
                    <span style="margin-left: 10px;" id="yearly-profit">-</span> / year
                </div>
            </div>

            <div class="metric-card revenue">
                <div class="metric-label">Daily Revenue</div>
                <div class="metric-value" id="daily-revenue">-</div>
                <div class="metric-sub">
                    <span id="daily-btc">-</span> BTC/day
                </div>
            </div>

            <div class="metric-card cost">
                <div class="metric-label">Daily Power Cost</div>
                <div class="metric-value" id="daily-cost">-</div>
                <div class="metric-sub">
                    <span id="daily-kwh">-</span> kWh/day
                </div>
            </div>

            <div class="metric-card hashrate">
                <div class="metric-label">Fleet Hashrate</div>
                <div class="metric-value" id="fleet-hashrate">-</div>
                <div class="metric-sub">
                    <span id="fleet-power">-</span> power
                    • <span id="efficiency">-</span> J/TH
                </div>
            </div>
        </div>

        <!-- Additional Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Profit Margin</div>
                <div class="metric-value" id="profit-margin">-</div>
                <div class="metric-sub">Profit / Revenue</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Break-Even BTC Price</div>
                <div class="metric-value" id="break-even">-</div>
                <div class="metric-sub">Price at which profit = $0</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Active Miners</div>
                <div class="metric-value" id="miner-count">-</div>
                <div class="metric-sub">Fleet size</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Power Cost Rate</div>
                <div class="metric-value" id="power-rate">-</div>
                <div class="metric-sub">Average USD per kWh</div>
            </div>
        </div>

        <!-- Profitability Chart -->
        <div class="chart-container">
            <div class="chart-title">Profitability Trend</div>
            <canvas id="profitChart" style="max-height: 400px;"></canvas>
        </div>

        <!-- Individual Miner Contributions -->
        <div class="chart-container" style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                <div class="chart-title" style="margin: 0;">Individual Miner Contributions</div>
                <button id="toggleMinerTable" class="period-btn active"
                        style="background: var(--primary); color: white; border-color: var(--primary);">
                    Show Details
                </button>
            </div>

            <div id="minerContributionsSection" style="display: none;">
                <!-- Controls for per-miner calculations -->
                <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="filter-group">
                        <div class="filter-label">Electricity Rate ($/kWh)</div>
                        <input type="number" id="minerElectricityRate" class="filter-select"
                               style="width: 150px; padding: 8px 12px;"
                               step="0.001" min="0" placeholder="0.10" value="0.10">
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Active Within (minutes)</div>
                        <select id="minerFreshWithin" class="filter-select" style="width: 150px;">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="120">120 minutes</option>
                        </select>
                    </div>
                    <div>
                        <button id="applyMinerFilters" class="period-btn"
                                style="padding: 8px 20px; background: var(--primary); color: white; border-color: var(--primary);">
                            Apply
                        </button>
                    </div>
                    <div id="minerStatus" style="color: var(--muted); font-size: 0.875rem;"></div>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Total Hashrate
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);" id="minerTotalHash">—
                        </div>
                    </div>
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Total Power
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);" id="minerTotalPower">—
                        </div>
                    </div>
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem;">
                            BTC/TH/Day
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--text);" id="minerBtcPerThDay">—
                        </div>
                    </div>
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Daily Revenue
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #007bff;" id="minerDailyRevenue">—
                        </div>
                    </div>
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Daily Cost
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #dc3545;" id="minerDailyCost">—</div>
                    </div>
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem;">
                            Daily Profit
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700;" id="minerDailyProfit">—</div>
                    </div>
                </div>

                <!-- Miner Table -->
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Model</th>
                            <th>Hashrate (TH/s)</th>
                            <th>Power (W)</th>
                            <th>Revenue/Day (USD)</th>
                            <th>Cost/Day (USD)</th>
                            <th>Profit/Day (USD)</th>
                        </tr>
                        </thead>
                        <tbody id="minerContributionsTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: var(--muted);">
                                Click "Apply" to load miner data
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let profitChart = null;

        async function loadBTCPrice() {
            try {
                const priceEl = document.getElementById('btc-price');
                const response = await fetch('/api/profitability/btc-price', {cache: 'no-store'});
                if (response.ok) {
                    const data = await response.json();
                    if (data && (data.ok || typeof data.btc_price_usd === 'number')) {
                        priceEl.textContent = '$' + Number(data.btc_price_usd).toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        return;
                    }
                }
                // Fallback: try CoinGecko directly if API failed or returned error
                try {
                    const cg = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd', {cache: 'no-store'});
                    if (cg.ok) {
                        const cgData = await cg.json();
                        const price = cgData?.bitcoin?.usd;
                        if (typeof price === 'number') {
                            priceEl.textContent = '$' + Number(price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            return;
                        }
                    }
                    priceEl.textContent = 'N/A';
                } catch (_) {
                    priceEl.textContent = 'N/A';
                }
            } catch (error) {
                console.error('Failed to load BTC price:', error);
                document.getElementById('btc-price').textContent = 'Error';
            }
        }

        async function loadNetworkDifficulty() {
            try {
                const response = await fetch('/api/profitability/network-difficulty');
                const data = await response.json();

                if (data.ok && data.network_difficulty) {
                    const diff = data.network_difficulty;
                    document.getElementById('network-diff').textContent = diff > 1e12 ? (diff / 1e12).toFixed(2) + 'T' : diff.toLocaleString();
                } else {
                    document.getElementById('network-diff').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Failed to load network difficulty:', error);
                document.getElementById('network-diff').textContent = 'Error';
            }
        }

        function getStoredPowerRate() {
            try {
                const v = localStorage.getItem('power_rate');
                if (v != null && v !== '') return parseFloat(v);
            } catch (_) {
            }
            return null;
        }

        function setStoredPowerRate(v) {
            try { localStorage.setItem('power_rate', String(v)); } catch (_) {}
        }

        async function loadCurrentProfitability() {
            try {
                const minerFilter = document.getElementById('minerFilter').value;
                const activeOnly = minerFilter === 'active' ? 'true' : 'false';
                const rateInput = document.getElementById('powerRate');
                const rateVal = parseFloat(rateInput.value || getStoredPowerRate() || '');
                const params = new URLSearchParams({active_only: activeOnly});
                if (isFinite(rateVal)) params.set('power_cost', String(rateVal));

                const response = await fetch(`/api/profitability/current?${params.toString()}`);
                const data = await response.json();

                if (!data.ok || !data.profitability) {
                    console.error('No profitability data');
                    return;
                }

                const p = data.profitability;

                // Profit
                const dailyProfit = p.daily_profit_usd || 0;
                document.getElementById('daily-profit').textContent =
                    '$' + dailyProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('daily-profit').className = 'metric-value ' + (dailyProfit >= 0 ? 'metric-positive' : 'metric-negative');

                document.getElementById('monthly-profit').textContent =
                    '$' + (p.monthly_profit_usd || 0).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                document.getElementById('yearly-profit').textContent =
                    '$' + (p.yearly_profit_usd || 0).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });

                // Revenue
                document.getElementById('daily-revenue').textContent =
                    '$' + (p.estimated_revenue_usd_per_day || 0).toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                document.getElementById('daily-btc').textContent =
                    (p.estimated_btc_per_day || 0).toFixed(6);

                // Cost
                document.getElementById('daily-cost').textContent =
                    '$' + (p.daily_power_cost_usd || 0).toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                document.getElementById('daily-kwh').textContent =
                    (p.daily_power_kwh || 0).toFixed(1);

                // Hashrate
                document.getElementById('fleet-hashrate').textContent =
                    (p.hashrate_ths || 0).toFixed(2) + ' TH/s';
                document.getElementById('fleet-power').textContent =
                    (p.power_w || 0).toFixed(0) + 'W';
                document.getElementById('efficiency').textContent =
                    (p.efficiency_j_per_th || 0).toFixed(1);

                // Additional metrics
                const margin = p.profit_margin_pct || 0;
                document.getElementById('profit-margin').textContent = margin.toFixed(1) + '%';
                document.getElementById('profit-margin').className = 'metric-value ' + (margin >= 0 ? 'metric-positive' : 'metric-negative');

                document.getElementById('break-even').textContent =
                    '$' + (p.break_even_btc_price || 0).toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });

                document.getElementById('miner-count').textContent = p.miner_count || 0;

                document.getElementById('power-rate').textContent =
                    '$' + (p.power_cost_usd_per_kwh || rateVal || 0).toFixed(4);

            } catch (error) {
                console.error('Failed to load profitability:', error);
            }
        }

        async function loadHistory() {
            try {
                const minerFilter = document.getElementById('minerFilter').value;
                const timeFilter = document.getElementById('timeFilter').value;
                const rateInput = document.getElementById('powerRate');
                const rateVal = parseFloat(rateInput.value || getStoredPowerRate() || '');

                // Convert time filter to days
                let days = 7; // default
                switch (timeFilter) {
                    case '24h':
                        days = 1;
                        break;
                    case '7d':
                        days = 7;
                        break;
                    case '30d':
                        days = 30;
                        break;
                }

                const activeOnly = minerFilter === 'active' ? 'true' : 'false';

                const params = new URLSearchParams({days: String(days), active_only: activeOnly});
                if (isFinite(rateVal)) params.set('power_cost', String(rateVal));

                const response = await fetch(`/api/profitability/history?${params.toString()}`);
                const data = await response.json();

                if (!data.ok || !data.history || data.history.length === 0) {
                    console.log('No profitability history');
                    return;
                }

                // Prepare chart data
                const labels = data.history.map(h => {
                    const date = new Date(h.timestamp);
                    return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', hour: '2-digit'});
                });

                const profitData = data.history.map(h => h.daily_profit_usd);
                const revenueData = data.history.map(h => h.estimated_revenue_usd_per_day);
                const costData = data.history.map(h => h.daily_power_cost_usd);

                // Create or update chart
                const ctx = document.getElementById('profitChart').getContext('2d');

                if (profitChart) {
                    profitChart.destroy();
                }

                profitChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Profit',
                                data: profitData,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Revenue',
                                data: revenueData,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Power Cost',
                                data: costData,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += '$' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        function updateFilterIndicator() {
            const minerFilter = document.getElementById('minerFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;

            let minerText = 'All Miners';
            if (minerFilter === 'active') {
                minerText = 'Active Miners Only';
            }

            let timeText = 'Past 7 Days';
            switch (timeFilter) {
                case '24h':
                    timeText = 'Past 24 Hours';
                    break;
                case '7d':
                    timeText = 'Past 7 Days';
                    break;
                case '30d':
                    timeText = 'Past 30 Days';
                    break;
            }

            document.getElementById('filterIndicator').textContent =
                `Showing: ${minerText} • ${timeText}`;
        }

        async function triggerSnapshot() {
            try {
                const response = await fetch('/api/profitability/snapshot', {method: 'POST'});
                const data = await response.json();

                if (data.ok) {
                    alert('Profitability snapshot saved');
                    loadHistory(7);
                } else {
                    alert('Failed to save snapshot: ' + data.error);
                }
            } catch (error) {
                alert('Error saving snapshot: ' + error.message);
            }
        }

        // Initial load
        // Restore stored power rate if available
        (function initPowerRate() {
            const input = document.getElementById('powerRate');
            const stored = getStoredPowerRate();
            if (stored != null) input.value = String(stored);
            else input.value = '0.10';
            input.addEventListener('change', () => {
                const v = parseFloat(input.value || '');
                if (isFinite(v)) setStoredPowerRate(v);
                loadCurrentProfitability();
                loadHistory();
            });
        })();

        loadBTCPrice();
        loadNetworkDifficulty();
        loadCurrentProfitability();
        loadHistory();
        updateFilterIndicator();

        // Filter change handlers
        document.getElementById('minerFilter').addEventListener('change', () => {
            loadCurrentProfitability();
            loadHistory();
            updateFilterIndicator();
        });

        document.getElementById('timeFilter').addEventListener('change', () => {
            loadHistory();
            updateFilterIndicator();
        });

        // Auto-refresh every 60 seconds
        setInterval(() => {
            loadBTCPrice();
            loadNetworkDifficulty();
            loadCurrentProfitability();
        }, 60000);

        // ========== Individual Miner Contributions ==========

        function fmt(n, digits = 2) {
            if (!isFinite(n)) return '—';
            return Number(n).toLocaleString(undefined, {maximumFractionDigits: digits});
        }

        function loadMinerPrefs() {
            try {
                const rate = localStorage.getItem('miner_rate');
                const freshWithin = localStorage.getItem('miner_fresh_within');
                if (rate) document.getElementById('minerElectricityRate').value = rate;
                if (freshWithin) document.getElementById('minerFreshWithin').value = freshWithin;
            } catch (e) {
                console.log('Could not load preferences:', e);
            }
        }

        function saveMinerPrefs(rate, freshWithin) {
            try {
                localStorage.setItem('miner_rate', String(rate));
                localStorage.setItem('miner_fresh_within', String(freshWithin));
            } catch (e) {
                console.log('Could not save preferences:', e);
            }
        }

        async function fetchDifficulty() {
            try {
                const response = await fetch('https://blockchain.info/q/getdifficulty', {cache: 'no-store'});
                if (!response.ok) throw new Error('Difficulty fetch failed');
                const text = await response.text();
                const diff = parseFloat(text);
                if (!isFinite(diff)) throw new Error('Invalid difficulty');
                return diff;
            } catch (error) {
                console.error('Failed to fetch difficulty:', error);
                return null;
            }
        }

        function btcPerTHPerDay(difficulty, rewardBtc = 3.125) {
            const two32 = 4294967296; // 2^32
            return (1e12 * 86400 / (difficulty * two32)) * rewardBtc;
        }

        async function fetchMinersCurrent(freshWithin) {
            try {
                const params = new URLSearchParams({active_only: 'true', fresh_within: String(freshWithin)});
                const response = await fetch(`/api/miners/current?${params.toString()}`);
                if (!response.ok) throw new Error('Miners fetch failed');
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Failed to fetch miners:', error);
                return [];
            }
        }

        function renderMinerTable(miners, rate, usdPerThDay, btcPrice) {
            const tbody = document.getElementById('minerContributionsTable');
            if (!tbody) return {totalHash: 0, totalPower: 0, totalCost: 0, totalRev: 0};

            let totalHash = 0;
            let totalPower = 0;
            let totalCost = 0;
            let totalRev = 0;

            if (miners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--muted);">No active miners found</td></tr>';
                return {totalHash: 0, totalPower: 0, totalCost: 0, totalRev: 0};
            }

            const rows = miners.map(m => {
                const hr = Number(m.hashrate_ths || 0);
                const pw = Number(m.power_w || 0);
                totalHash += hr;
                totalPower += pw;

                const revUsd = hr * usdPerThDay;
                const costUsd = (pw / 1000) * 24 * rate;
                const profitUsd = revUsd - costUsd;

                totalRev += revUsd;
                totalCost += costUsd;

                const profitColor = profitUsd >= 0 ? '#28a745' : '#dc3545';

                return `
                <tr>
                    <td><a href="/dashboard/?ip=${encodeURIComponent(m.ip || '')}" style="color: var(--primary); text-decoration: none;">${m.ip || '—'}</a></td>
                    <td>${m.model || '—'}</td>
                    <td>${fmt(hr, 3)}</td>
                    <td>${fmt(pw, 0)}</td>
                    <td>$${fmt(revUsd, 2)}</td>
                    <td>$${fmt(costUsd, 2)}</td>
                    <td style="font-weight: 600; color: ${profitColor};">$${fmt(profitUsd, 2)}</td>
                </tr>
            `;
            }).join('');

            tbody.innerHTML = rows;
            return {totalHash, totalPower, totalCost, totalRev};
        }

        async function refreshMinerContributions() {
            const status = document.getElementById('minerStatus');
            const rate = parseFloat(document.getElementById('minerElectricityRate').value || '0.1');
            const freshWithin = parseInt(document.getElementById('minerFreshWithin').value || '30', 10);
            saveMinerPrefs(rate, freshWithin);

            try {
                if (status) status.textContent = 'Loading…';

                // Fetch BTC price first (from already loaded value or fetch again)
                const btcPriceEl = document.getElementById('btc-price');
                const btcPriceText = btcPriceEl.textContent.replace(/[^0-9.]/g, '');
                let btcPrice = parseFloat(btcPriceText);

                if (!btcPrice || !isFinite(btcPrice)) {
                    const response = await fetch('/api/profitability/btc-price');
                    const data = await response.json();
                    btcPrice = data.ok ? data.btc_price_usd : 0;
                }

                // Fetch difficulty and miners
                const [diff, miners] = await Promise.all([
                    fetchDifficulty(),
                    fetchMinersCurrent(freshWithin)
                ]);

                let btcThDay = null;
                if (diff) {
                    btcThDay = btcPerTHPerDay(diff, 3.125);
                }

                // Update BTC/TH/Day display
                const btcPerThDayEl = document.getElementById('minerBtcPerThDay');
                if (btcThDay != null) {
                    btcPerThDayEl.textContent = `${fmt(btcThDay, 8)} BTC`;
                } else {
                    btcPerThDayEl.textContent = '—';
                }

                // Calculate USD per TH/day
                const usdPerThDay = (btcThDay != null) ? (btcThDay * btcPrice) : 0;

                // Render table and get totals
                const {
                    totalHash,
                    totalPower,
                    totalCost,
                    totalRev
                } = renderMinerTable(miners, rate, usdPerThDay, btcPrice);

                // Update summary cards
                document.getElementById('minerTotalHash').textContent = `${fmt(totalHash, 3)} TH/s`;
                document.getElementById('minerTotalPower').textContent = `${fmt(totalPower, 0)} W`;
                document.getElementById('minerDailyRevenue').textContent = `$${fmt(totalRev, 2)}`;
                document.getElementById('minerDailyCost').textContent = `$${fmt(totalCost, 2)}`;

                const profit = totalRev - totalCost;
                const profitEl = document.getElementById('minerDailyProfit');
                profitEl.textContent = `$${fmt(profit, 2)}`;
                profitEl.style.color = profit >= 0 ? '#28a745' : '#dc3545';

                if (status) status.textContent = `Updated ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Failed to refresh miner contributions:', error);
                if (status) status.textContent = 'Failed to load data';
            }
        }

        // Toggle miner contributions visibility
        document.getElementById('toggleMinerTable').addEventListener('click', function () {
            const section = document.getElementById('minerContributionsSection');
            const button = this;

            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = 'Hide Details';
                // Auto-load data if not loaded yet
                const tbody = document.getElementById('minerContributionsTable');
                if (tbody.textContent.includes('Click "Apply"')) {
                    refreshMinerContributions();
                }
            } else {
                section.style.display = 'none';
                button.textContent = 'Show Details';
            }
        });

        // Apply button handler
        document.getElementById('applyMinerFilters').addEventListener('click', refreshMinerContributions);

        // Load saved preferences
        loadMinerPrefs();
    </script>
{% endblock %}
