{% extends "base.html" %}

{% block title %}Firmware Flashing - Miner Monitor{% endblock %}

{% block content %}
    <div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 0 2rem;">
        <header class="page-header" style="margin-bottom: 2.5rem; padding: 1.5rem 0;">
            <div class="header-content"
                 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; font-weight: 700; color: var(--text);">
                        <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2em;">üõ†Ô∏è</span>
                            <span>Firmware Flashing Workbench</span>
                        </span>
                    </h1>
                    <p style="margin: 0; color: var(--muted); max-width: 720px; line-height: 1.5;">
                        Manage and deploy firmware updates to your mining hardware. Upload new firmware images,
                        schedule updates, and monitor flash job progress across your mining fleet.
                    </p>
                </div>
                <div class="header-actions" style="display: flex; gap: 0.75rem;">
                    <button onclick="showUploadPicker()" class="btn"
                            style="background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span>üì§ Upload Firmware</span>
                    </button>
                    <button onclick="loadFirmwareImages()" class="btn"
                            style="border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span>üîÑ Refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="dashboard-grid"
             style="display: grid; gap: 2rem; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); grid-template-areas: 'library jobs' 'recent recent';">
            <!-- Firmware Library Card -->
            <section class="card"
                     style="grid-area: library; :root {
  /* Design token for primary surface background */
  --color-surface-primary: #f5f5f5;
}

/* ... existing code ... */

background-color: var(--color-surface-primary);; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; padding: 1.75rem;">
                <div class="card-inner" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-header"
                         style="margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üì¶</span>
                            <span>Firmware Library</span>
                        </h2>
                        <p style="margin: 0.5rem 0 0; color: var(--muted); font-size: 0.9rem;">
                            Manage and organize your firmware images. Upload new or update existing firmware.
                        </p>
                    </div>

                    <!-- Upload Form (Hidden by default) -->
                    <div id="upload-form-container" style="margin-bottom: 1.5rem; display: none;">
                        <form id="upload-form" enctype="multipart/form-data" style="display: grid; gap: 1rem;">
                            <div>
                                <label class="form-label"
                                       style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted);">Firmware
                                    File</label>
                                <input type="file" id="firmware-file" name="file" class="form-control"
                                       accept=".bin,.tar,.tar.gz,.zip,.img" required
                                       style="width: 100%; padding: 0.75rem; border: 1px dashed var(--border); border-radius: 8px; background: var(--surface-2);">
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                                <div>
                                    <label class="form-label"
                                           style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Vendor</label>
                                    <input type="text" name="vendor" placeholder="e.g. Bitmain" class="form-control">
                                </div>
                                <div>
                                    <label class="form-label"
                                           style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Model</label>
                                    <input type="text" name="model" placeholder="e.g. S19 Pro" class="form-control">
                                </div>
                                <div>
                                    <label class="form-label"
                                           style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Version</label>
                                    <input type="text" name="version" placeholder="e.g. v1.2.3" class="form-control">
                                </div>
                            </div>

                            <div>
                                <label class="form-label"
                                       style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Notes</label>
                                <textarea name="notes" rows="2"
                                          placeholder="Add any relevant notes about this firmware..."
                                          class="form-control"
                                          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; resize: vertical;"></textarea>
                            </div>

                            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 0.5rem;">
                                <button type="button" class="btn"
                                        onclick="document.getElementById('upload-form-container').style.display='none'"
                                        style="padding: 0.6rem 1.25rem; border: 1px solid var(--border);">
                                    Cancel
                                </button>
                                <button type="submit" class="btn"
                                        style="padding: 0.6rem 1.5rem; background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 0.5rem;">
                                    <span>‚¨ÜÔ∏è</span>
                                    <span>Upload Firmware</span>
                                </button>
                            </div>

                            <div id="upload-status"
                                 style="font-size: 0.85rem; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; display: none;"></div>
                        </form>
                    </div>

                    <div class="firmware-list-container"
                         style="margin-top: 1.5rem; flex: 1; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-muted);">
                                Available Images</h3>
                            <div class="filters" style="display: flex; gap: 0.5rem;">
                                <select class="form-control"
                                        style="padding: 0.4rem 0.5rem; font-size: 0.85rem; border-radius: 6px; border: 1px solid var(--border);">
                                    <option>All Vendors</option>
                                    <option>Bitmain</option>
                                    <option>MicroBT</option>
                                    <option>Canaan</option>
                                </select>
                                <button class="btn" type="button"
                                        style="padding: 0.4rem 0.75rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.35rem;"
                                        onclick="loadFirmwareImages()">
                                    <span>üîÑ</span>
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                        <div id="firmware-list"
                             style="display: grid; gap: 0.75rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Create Job Card -->
            <section class="card"
                     style="grid-area: jobs; background: var(--surface-1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; padding: 1.75rem;">
                <div class="card-inner" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-header"
                         style="margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üöÄ</span>
                            <span>Create Flash Job</span>
                        </h2>
                        <p style="margin: 0.5rem 0 0; color: var(--muted); font-size: 0.9rem;">
                            Select firmware and target miners to create a new flash job.
                        </p>
                    </div>

                    <div style="display: grid; gap: 1.25rem;">
                        <div>
                            <label class="form-label"
                                   style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted);">Firmware
                                Image</label>
                            <select id="firmware-select" class="form-control"
                                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--surface-2);">
                                <option value="" disabled selected>Select a firmware image</option>
                            </select>
                        </div>

                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label class="form-label" style="font-weight: 500; color: var(--text-muted);">Target
                                    Miners</label>
                                <span id="selected-miners-count" style="font-size: 0.8rem; color: var(--muted);">0 selected</span>
                            </div>

                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="miner-search" placeholder="Search miners..."
                                       class="form-control"
                                       style="flex: 1; min-width: 220px; padding: 0.6rem 0.75rem; border-radius: 6px;">
                                <label for="online-only-toggle" style="display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.9rem; color: var(--text-muted); white-space: nowrap;">
                                    <input type="checkbox" id="online-only-toggle" checked>
                                    Online only
                                </label>
                                <button class="btn" style="padding: 0 1rem; border: 1px solid var(--border);" onclick="loadMiners()">
                                    Refresh
                                </button>
                                <div style="flex: 1"></div>
                                <button class="btn" style="padding: 0 1rem; border: 1px solid var(--border);"
                                        onclick="selectVisibleMiners(true)">
                                    All
                                </button>
                                <button class="btn" style="padding: 0 1rem; border: 1px solid var(--border);"
                                        onclick="selectVisibleMiners(false)">
                                    None
                                </button>
                            </div>

                            <div id="miner-checkboxes"
                                 style="height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; background: var(--surface-2);">
                                <!-- Dynamically populated -->
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted);">
                                    Loading miners...
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 0.5rem;">
                            <button id="create-job-btn" class="btn"
                                    style="width: 100%; padding: 0.8rem; background: var(--primary); color: white; font-weight: 500; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                                    onclick="createFlashJobs()"
                                    disabled>
                                <span>üöÄ</span>
                                <span>Create Flash Job</span>
                            </button>
                            <p style="color: var(--muted); font-size: 0.8rem; margin: 0.75rem 0 0; text-align: center; line-height: 1.5;">
                                The firmware will be flashed to all selected miners. This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Jobs Card -->
            <section class="card"
                     style="grid-area: recent; background: var(--surface-1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; padding: 1.75rem; margin-top: 0.5rem;">
                <div class="card-inner" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-header"
                         style="margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìã</span>
                            <span>Recent Flash Jobs</span>
                        </h2>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <button class="btn"
                                    style="padding: 0.3rem 0.75rem; font-size: 0.8rem; border: 1px solid var(--border);"
                                    onclick="loadRecentJobs()">
                                <span>üîÑ</span>
                                <span>Refresh</span>
                            </button>
                            <button class="btn"
                                    style="padding: 0.3rem 0.75rem; font-size: 0.8rem; border: 1px solid var(--border);"
                                    onclick="clearFlashHistory()">
                                <span>üßπ</span>
                                <span>Clear History</span>
                            </button>
                            <div style="flex: 1;"></div>
                            <div style="display: flex; gap: 0.75rem; font-size: 0.85rem;">
                                <div style="display: flex; align-items: center; gap: 0.35rem;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--success);"></span>
                                    <span>Completed</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.35rem;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--warning);"></span>
                                    <span>In Progress</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.35rem;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--danger);"></span>
                                    <span>Failed</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="job-list" style="min-height: 200px;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--muted);">
                            <div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; margin-bottom: 1rem; animation: spin 1s linear infinite;"></div>
                            <p>Loading flash jobs...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <style>
        /* Base Styles */
        :root {
            --primary: #4f46e5;
            --primary-soft: rgba(79, 70, 229, 0.2);
            --primary-hover: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --surface: #1e293b;
            --surface-1: #27303f; /* Added missing surface-1 variable */
            --surface-2: #334155;
            --surface-3: #475569;
            --border: #334155;
            --muted: #64748b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(51, 65, 85, 0.5);
            --card-hover: rgba(51, 65, 85, 0.3);
        }

        /* Card Styles */
        .card {
            background: var(--surface-1);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -4px rgba(0, 0, 0, 0.12), 0 8px 16px -4px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-soft);
        }

        /* Form Elements */
        .form-control {
            display: block;
            width: 100%;
            padding: 0.7rem 1rem;
            font-size: 0.925rem;
            line-height: 1.5;
            color: var(--text);
            background-color: var(--surface-2);
            background-clip: padding-box;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.65rem 1.25rem;
            border-radius: 8px;
            font-size: 0.925rem;
            font-weight: 500;
            line-height: 1.4;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid transparent;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Firmware Item */
        .firmware-item {
            padding: 1.25rem;
            border-radius: 10px;
            background-color: var(--surface-2);
            margin-bottom: 0.875rem;
            border: 1px solid var(--border);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .firmware-item:hover {
            transform: translateX(2px);
            border-color: var(--primary-soft);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Job List */
        .job-item {
            padding: 1rem;
            border-radius: 10px;
            background: var(--surface-2);
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--muted);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .job-item:hover {
            transform: translateX(4px);
        }

        .job-item.completed {
            border-left-color: var(--success);
        }

        .job-item.in-progress {
            border-left-color: var(--warning);
        }

        .job-item.failed {
            border-left-color: var(--danger);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .job-title {
            font-weight: 600;
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .job-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .job-progress {
            height: 6px;
            background: var(--surface-3);
            border-radius: 3px;
            margin: 0.75rem 0;
            overflow: hidden;
        }

        .job-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-hover));
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 2%;
            position: relative;
            overflow: hidden;
        }

        .job-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                    90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0) 100%
            );
            animation: progress-shimmer 1.5s infinite linear;
        }

        @keyframes progress-shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .miner-checkbox {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--surface-2);
            border: 1px solid var(--border);
        }

        .miner-checkbox:hover {
            background: var(--surface-3);
            transform: translateX(2px);
        }

        .job-status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--surface-3);
        }

        .job-status.completed {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .job-status.in-progress {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .job-status.failed {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Animations */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-areas: 'library' 'jobs' 'recent';
            }

            .card {
                padding: 1.25rem;
            }
        }

        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>

    <script>
        let miners = [];
        let firmwareImages = [];
        let activeJobs = [];
        let onlineOnly = true;

        document.addEventListener('DOMContentLoaded', () => {
            loadFirmwareImages();
            loadMiners();
            pollJobs();

            const form = document.getElementById('upload-form');
            form.addEventListener('submit', handleUpload);

            const fileInput = document.getElementById('firmware-file');
            fileInput.addEventListener('change', () => {
                // Ensure the upload form is visible when a file is chosen
                const container = document.getElementById('upload-form-container');
                container.style.display = 'block';
                const statusEl = document.getElementById('upload-status');
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--muted)';
                statusEl.textContent = fileInput.files && fileInput.files[0]
                    ? `${fileInput.files[0].name} selected`
                    : '';
            });

            const firmwareSelect = document.getElementById('firmware-select');
            firmwareSelect.addEventListener('change', updateActionState);

            const searchInput = document.getElementById('miner-search');
            searchInput.addEventListener('input', filterMiners);

            const onlineToggle = document.getElementById('online-only-toggle');
            try {
                const saved = localStorage.getItem('firmware_online_only');
                if (saved === 'true' || saved === 'false') {
                    onlineOnly = (saved === 'true');
                    onlineToggle.checked = onlineOnly;
                }
            } catch (e) {}
            onlineToggle.addEventListener('change', () => {
                onlineOnly = onlineToggle.checked;
                try { localStorage.setItem('firmware_online_only', String(onlineOnly)); } catch (e) {}
                renderMinerCheckboxes();
            });
        });

        async function loadFirmwareImages() {
            try {
                const res = await fetch('/api/remote/firmware/images');
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to load firmware images');

                firmwareImages = data.images || [];
                renderFirmwareList();
                populateFirmwareSelect();
            } catch (error) {
                document.getElementById('firmware-list').innerHTML = `<div class="alert">${error.message}</div>`;
            }
        }

        function renderFirmwareList() {
            const container = document.getElementById('firmware-list');
            if (firmwareImages.length === 0) {
                container.innerHTML = '<p style="color: var(--muted);">No firmware images registered yet.</p>';
                return;
            }

            container.innerHTML = firmwareImages.map(image => {
                const badges = [];
                if (image.vendor) badges.push(`<span class="badge">${image.vendor}</span>`);
                if (image.model) badges.push(`<span class="badge">${image.model}</span>`);
                if (image.version) badges.push(`<span class="badge">v${image.version}</span>`);

                return `
                <div class="firmware-item">
                    <div class="top-row">
                        <div>
                            <strong>${image.file_name}</strong>
                            <div class="badges">${badges.join(' ')}</div>
                        </div>
                        <div class="meta">
                            ${formatBytes(image.size_bytes)} ¬∑ ${image.checksum.slice(0, 8)}
                        </div>
                    </div>
                    <div class="bottom-row">
                        Uploaded ${formatDate(image.created_at)} by ${image.uploaded_by || 'N/A'}
                    </div>
                    ${image.notes ? `<div class="notes">${image.notes}</div>` : ''}
                    <div class="actions">
                        <a class="btn-link" href="/api/remote/firmware/images/${image.id}/download" download>
                            ‚¨áÔ∏è Download
                        </a>
                        <a class="btn-link" href="#" onclick="return deleteFirmwareImage(${image.id})" style="color:#ef4444;">
                            üóëÔ∏è Remove
                        </a>
                    </div>
                </div>
            `;
            }).join('');
        }

        function populateFirmwareSelect() {
            const select = document.getElementById('firmware-select');
            if (firmwareImages.length === 0) {
                select.innerHTML = '<option value="">-- No firmware available --</option>';
                select.disabled = true;
                updateActionState();
                return;
            }
            select.disabled = false;
            select.innerHTML = '<option value="">-- Choose firmware --</option>' + firmwareImages.map(image => (
                `<option value="${image.id}">${image.file_name} (${image.version || 'version ?'})</option>`
            )).join('');
            updateActionState();
        }

        async function loadMiners() {
            try {
                const res = await fetch('/api/miners');
                const data = await res.json();
                miners = data.miners || [];
                renderMinerCheckboxes();
            } catch (error) {
                document.getElementById('miner-checkboxes').innerHTML = `<div class="alert">${error.message}</div>`;
            }
        }

        function isMinerOnline(miner) {
            try {
                const status = (miner.status || '').toString().toLowerCase();
                if (status && ['online','alive','ok','healthy'].includes(status)) return true;
                if (typeof miner.is_stale === 'boolean') return !miner.is_stale;
                const age = Number(miner.age_sec);
                if (!Number.isNaN(age)) return age <= 120; // 2 minutes grace if provided
            } catch (e) {}
            return false;
        }

        function getVisibleMiners() {
            const q = (document.getElementById('miner-search').value || '').toLowerCase().trim();
            return (miners || []).filter(m => {
                if (onlineOnly && !isMinerOnline(m)) return false;
                if (!q) return true;
                const hay = `${m.ip || ''} ${m.model || ''} ${m.vendor || ''} ${m.hostname || ''}`.toLowerCase();
                return hay.includes(q);
            });
        }

        function renderMinerCheckboxes() {
            const container = document.getElementById('miner-checkboxes');
            if (!miners || miners.length === 0) {
                container.innerHTML = '<p style="color: var(--muted);">No miners available.</p>';
                updateSelectedCount();
                return;
            }
            const visible = getVisibleMiners();

            // Preserve checked selections across re-renders
            const previouslyChecked = new Set(Array.from(document.querySelectorAll('#miner-checkboxes input:checked')).map(cb => cb.value));

            if (visible.length === 0) {
                const msg = onlineOnly
                    ? '<p style="color: var(--muted);">No online miners match your filters. <a href="#" onclick="document.getElementById(\'online-only-toggle\').checked=false; onlineOnly=false; renderMinerCheckboxes(); return false;">Show all miners</a>.</p>'
                    : '<p style="color: var(--muted);">No miners match your filters.</p>';
                container.innerHTML = msg;
                updateSelectedCount();
                return;
            }

            container.innerHTML = visible.map(miner => `
                <label class="miner-item" style="display: block; padding: 0.25rem 0;">
                    <input type="checkbox" value="${miner.ip}" ${previouslyChecked.has(String(miner.ip)) ? 'checked' : ''}> ${miner.ip}
                    <span style="color: var(--muted); font-size: 0.85rem;">${miner.model || ''}</span>
                    ${isMinerOnline(miner) ? '<span style="color:#10b981; font-size: 0.75rem; margin-left: .5rem;">‚óè online</span>' : '<span style="color:#ef4444; font-size: 0.75rem; margin-left: .5rem;">‚óè offline</span>'}
                </label>
            `).join('');
            attachMinerCheckboxListeners();
            updateSelectedCount();
        }

        function selectVisibleMiners(checked) {
            const container = document.getElementById('miner-checkboxes');
            container.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = !!checked);
            updateSelectedCount();
        }

        async function createFlashJobs() {
            const firmwareId = document.getElementById('firmware-select').value;
            if (!firmwareId) {
                alert('Please choose a firmware image.');
                return;
            }

            const selectedMinerIps = Array.from(document.querySelectorAll('#miner-checkboxes input:checked')).map(cb => cb.value);
            if (selectedMinerIps.length === 0) {
                alert('Select at least one miner.');
                return;
            }

            if (!confirm(`Stage firmware flash for ${selectedMinerIps.length} miner(s)?`)) {
                return;
            }

            try {
                const res = await fetch('/api/remote/firmware/jobs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        firmware_id: Number(firmwareId),
                        miner_ips: selectedMinerIps,
                    })
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to create jobs');

                alert(data.message);
                activeJobs.push(...data.jobs.map(job => job.job_id));
                await loadRecentJobs(data.jobs.map(job => job.job_id));
                // Reset selections for safety
                document.querySelectorAll('#miner-checkboxes input[type=checkbox]').forEach(cb => cb.checked = false);
                updateSelectedCount();
            } catch (error) {
                alert(error.message);
            }
        }

        function renderJobCard(job) {
            return `
                <div class="job-card" style="padding: 1rem; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; gap: 1rem;">
                        <div>
                            <strong>${job.miner_ip}</strong>
                            <div style="color: var(--muted); font-size: 0.9rem;">${job.firmware?.file_name || 'Unknown firmware'}</div>
                            <div style="color: var(--muted); font-size: 0.8rem;">Created ${formatDate(job.created_at)}</div>
                            <div style="color: var(--muted); font-size: 0.8rem;">Progress details: ${job.metadata?.history?.slice(-1)[0]?.message || '‚Äî'}</div>
                        </div>
                        <span style="align-self: flex-start; padding: 0.35rem 0.8rem; border-radius: 999px; font-size: 0.85rem; background: ${job.status === 'success' ? '#10b981' : job.status === 'failed' ? '#ef4444' : (job.status === 'in_progress' ? '#f59e0b' : '#64748b')}; color: white;">
                            ${String(job.status || '').toUpperCase()}
                        </span>
                    </div>
                    <div style="margin-top: 0.75rem; background: var(--border); height: 8px; border-radius: 999px; overflow: hidden;">
                        <div style="width: ${job.progress || 0}%; height: 100%; background: var(--primary);"></div>
                    </div>
                    ${job.error_message ? `<div style=\"color: #ef4444; margin-top: 0.5rem;\">${job.error_message}</div>` : ''}
                </div>
            `;
        }

        async function loadRecentJobs(jobIds = []) {
            const container = document.getElementById('job-list');

            // Case 1: No explicit jobIds and no active jobs -> fetch the recent list endpoint
            if (jobIds.length === 0 && activeJobs.length === 0) {
                container.innerHTML = '<p style="color: var(--muted);">Loading recent jobs...</p>';
                try {
                    const res = await fetch('/api/remote/firmware/jobs');
                    const data = await res.json();
                    if (!data.ok) throw new Error(data.error || 'Failed to load jobs');
                    const jobs = data.jobs || [];
                    container.innerHTML = jobs.length
                        ? jobs.map(j => renderJobCard(j)).join('')
                        : '<p style="color: var(--muted);">No jobs found.</p>';
                } catch (error) {
                    container.innerHTML = `<div class="alert">${error.message}</div>`;
                }
                return;
            }

            // Case 2: We have specific job IDs (newly created or active) -> fetch each for live updates
            const idsToFetch = jobIds.length ? jobIds : activeJobs;
            container.innerHTML = 'Loading jobs...';
            try {
                const results = await Promise.all(idsToFetch.map(async (jobId) => {
                    const res = await fetch(`/api/remote/firmware/jobs/${jobId}`);
                    return res.json();
                }));

                const cards = results.map(result => {
                    if (!result.ok) {
                        return `<div class="alert">${result.error || 'Unable to fetch job'}</div>`;
                    }
                    const job = result.job;
                    if (job.status === 'success' || job.status === 'failed') {
                        activeJobs = activeJobs.filter(id => id !== job.job_id);
                    }
                    return renderJobCard(job);
                }).join('');

                container.innerHTML = cards || '<p style="color: var(--muted);">No jobs found.</p>';
            } catch (error) {
                container.innerHTML = `<div class="alert">${error.message}</div>`;
            }
        }

        async function clearFlashHistory() {
            try {
                if (!confirm('Clear all completed and failed firmware flash jobs from history?')) {
                    return;
                }
                const res = await fetch('/api/remote/firmware/jobs?status=non_active', { method: 'DELETE' });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to clear');
                alert(data.message || 'History cleared');
                // Refresh jobs panel
                activeJobs = [];
                await loadRecentJobs();
            } catch (err) {
                alert(err.message);
            }
        }

        async function deleteFirmwareImage(imageId) {
            try {
                if (!confirm('Remove this firmware image from the server? This cannot be undone.')) {
                    return false;
                }
                let res = await fetch(`/api/remote/firmware/images/${imageId}`, { method: 'DELETE' });
                if (res.status === 409) {
                    const proceed = confirm('This firmware is referenced by active jobs. Deactivate it instead so it can no longer be selected?');
                    if (!proceed) return false;
                    res = await fetch(`/api/remote/firmware/images/${imageId}?deactivate=true`, { method: 'DELETE' });
                }
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Failed to remove');
                alert(data.message || 'Removed');
                // Refresh lists and selection
                await loadFirmwareImages();
                // If currently selected firmware was removed/deactivated, ensure button state updates
                updateActionState();
                return false;
            } catch (err) {
                alert(err.message);
                return false;
            }
        }

        async function handleUpload(event) {
            event.preventDefault();
            const statusEl = document.getElementById('upload-status');
            const formData = new FormData(event.target);

            if (!formData.get('file') || !formData.get('file').name) {
                statusEl.textContent = 'Please choose a file to upload.';
                statusEl.style.color = '#ef4444';
                return;
            }

            statusEl.textContent = 'Uploading...';
            statusEl.style.color = 'var(--muted)';
            try {
                const res = await fetch('/api/remote/firmware/upload', {
                    method: 'POST',
                    body: formData,
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'Upload failed');

                statusEl.textContent = data.message;
                statusEl.style.color = '#10b981';
                event.target.reset();
                await loadFirmwareImages();
            } catch (error) {
                statusEl.textContent = error.message;
                statusEl.style.color = '#ef4444';
            }
        }

        // --- UI helpers and interactions ---
        function showUploadPicker() {
            const container = document.getElementById('upload-form-container');
            container.style.display = 'block';
            const input = document.getElementById('firmware-file');
            input.click();
            setTimeout(() => container.scrollIntoView({behavior: 'smooth', block: 'start'}), 0);
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('#miner-checkboxes input[type=checkbox]:checked').length;
            const label = document.getElementById('selected-miners-count');
            label.textContent = `${count} selected`;
            updateActionState();
        }

        function updateActionState() {
            const firmwareId = document.getElementById('firmware-select').value;
            const selectedCount = document.querySelectorAll('#miner-checkboxes input[type=checkbox]:checked').length;
            const btn = document.getElementById('create-job-btn');
            const enable = Boolean(firmwareId) && selectedCount > 0;
            btn.disabled = !enable;
        }

        function attachMinerCheckboxListeners() {
            document.querySelectorAll('#miner-checkboxes input[type=checkbox]').forEach(cb => {
                cb.addEventListener('change', updateSelectedCount);
            });
        }

        function filterMiners() {
            // Re-render the list according to the current search query and onlineOnly toggle
            renderMinerCheckboxes();
        }

        async function pollJobs() {
            try {
                const res = await fetch('/api/remote/firmware/jobs');
                const data = await res.json();
                if (data.ok) {
                    const active = data.jobs.filter(job => job.status === 'pending' || job.status === 'in_progress');
                    activeJobs = active.map(job => job.job_id);
                    await loadRecentJobs();
                }
            } catch (error) {
                console.warn('Job polling failed:', error);
            } finally {
                setTimeout(pollJobs, 10000);
            }
        }

        function formatBytes(value) {
            if (!value && value !== 0) return '‚Äî';
            const units = ['B', 'KB', 'MB', 'GB'];
            let idx = 0;
            let val = value;
            while (val >= 1024 && idx < units.length - 1) {
                val /= 1024;
                idx += 1;
            }
            return `${val.toFixed(val >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;
        }

        function formatDate(isoString) {
            if (!isoString) return '‚Äî';
            try {
                return new Date(isoString).toLocaleString();
            } catch (error) {
                return isoString;
            }
        }
    </script>
{% endblock %}
