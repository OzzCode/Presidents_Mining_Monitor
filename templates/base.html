<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
    <title>{% block title %}Antminer Monitor{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/theme.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/dom_utils.js') }}" defer></script>
    {% block extra_head %}{% endblock %}
</head>
<body>
<!-- Navigation Header -->
<header class="site-header">
    <div class="header-row">
        <div class="brand">
            <a href="{{ url_for('home') }}" class="brand-link">
                <img src="{{ url_for('static', filename='img/LogoImg.png') }}" alt="Logo" class="brand-logo">
                <span class="brand-name">Antminer Monitor</span>
            </a>
        </div>

        <button class="menu-toggle" id="menuToggle" aria-label="Toggle navigation" aria-expanded="false"
                aria-controls="primaryNav">â˜°
        </button>

        <nav class="primary-nav" id="primaryNav">
            <ul class="nav-primary">
                <li><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li><a href="{{ url_for('dashboard.show_miners') }}">Miners</a></li>
                <li><a href="{{ url_for('dashboard.pools_page') }}">Pools</a></li>
                <li class="dropdown">
                    <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">More â–¾</button>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="{{ url_for('dashboard.alerts_page') }}" role="menuitem">Alerts</a></li>
                        <li><a href="{{ url_for('dashboard.profitability_page') }}" role="menuitem">Profitability</a>
                        </li>
                        <li><a href="{{ url_for('dashboard.analytics_page') }}" role="menuitem">Analytics</a></li>
                        <li><a href="{{ url_for('dashboard.electricity_page') }}" role="menuitem">âš¡ Electricity</a></li>
                        <li><a href="{{ url_for('dashboard.remote_control_page') }}" role="menuitem">ðŸŽ® Remote</a></li>
                        <li><a href="{{ url_for('dashboard.firmware_flash_page') }}" role="menuitem">ðŸ§° Firmware</a></li>
                        <li><a href="{{ url_for('dashboard.logs_page') }}" role="menuitem">Logs</a></li>
                        <li class="menu-sep" role="separator"></li>
                        <li><a href="{{ url_for('home') }}" role="menuitem">Home</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <div class="nav-actions">
            <div id="btc-header-widget" class="btc-widget">
                <div class="btc-meta">
                    <div class="btc-label">Current BTC Price</div>
                    <div id="btc-price" class="btc-price">â€”</div>
                    <div id="btc-updated" class="btc-updated">â€”</div>
                </div>
                <div class="btc-chart-wrap">
                    <canvas id="btc-chart" height="44"></canvas>
                </div>
            </div>

            <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle color theme">
                <span aria-hidden="true">ðŸŒ“</span>
                Theme
            </button>

            <div class="auth-area">
                {% if g.user %}
                    <span class="hello">Hi, {{ g.user.username }}</span>
                    <a class="btn" href="{{ url_for('auth.logout') }}">Logout</a>
                {% else %}
                    <a class="btn" href="{{ url_for('auth.login') }}">Login</a>
                {% endif %}
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
{% block content %}{% endblock %}

<!-- BTC Price Widget Script -->
<script>
    // BTC Price Widget - Shared across all pages
    (function () {
        const priceEl = document.getElementById('btc-price');
        const updatedEl = document.getElementById('btc-updated');
        const chartCanvas = document.getElementById('btc-chart');

        if (!priceEl || !chartCanvas) return;

        let chart = null;
        const history = [];
        const MAX_POINTS = 20;

        async function fetchBTC() {
            try {
                const res = await fetch('https://api.coinbase.com/v2/prices/BTC-USD/spot');
                const data = await res.json();
                const price = parseFloat(data.data.amount);
                const now = Date.now();

                priceEl.textContent = '$' + price.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                updatedEl.textContent = new Date().toLocaleTimeString();

                history.push({x: now, y: price});
                if (history.length > MAX_POINTS) history.shift();

                updateChart();
            } catch (err) {
                console.error('BTC fetch error:', err);
            }
        }

        function updateChart() {
            if (!window.Chart) return;

            const ctx = chartCanvas.getContext('2d');
            if (!chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            data: history,
                            borderColor: '#f7931a',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {display: false},
                            y: {display: false}
                        },
                        plugins: {legend: {display: false}, tooltip: {enabled: false}}
                    }
                });
            } else {
                chart.data.datasets[0].data = history;
                chart.update('none');
            }
        }

        fetchBTC();
        setInterval(fetchBTC, 60000);
    })();
</script>

<script>
    // Header interactions: mobile menu & dropdown
    (function () {
        const initHeaderInteractions = () => {
            const menuToggle = document.getElementById('menuToggle');
            const primaryNav = document.getElementById('primaryNav');
            const dropdown = document.querySelector('.dropdown');
            const ddToggle = dropdown ? dropdown.querySelector('.dropdown-toggle') : null;

            if (menuToggle && primaryNav) {
                menuToggle.addEventListener('click', () => {
                    const isOpen = primaryNav.classList.toggle('open');
                    menuToggle.setAttribute('aria-expanded', String(isOpen));
                });
            }

            if (dropdown && ddToggle) {
                ddToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const open = dropdown.classList.toggle('open');
                    ddToggle.setAttribute('aria-expanded', String(open));
                });

                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('open');
                        ddToggle.setAttribute('aria-expanded', 'false');
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        dropdown.classList.remove('open');
                        ddToggle.setAttribute('aria-expanded', 'false');
                        if (document.activeElement && dropdown.contains(document.activeElement)) {
                            ddToggle.focus();
                        }
                    }
                });
            }
        };

        // Run immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHeaderInteractions);
        } else {
            initHeaderInteractions();
        }
    })();
</script>

{% block extra_scripts %}{% endblock %}
</body>
</html>
